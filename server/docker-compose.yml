services:
    db:
        image: postgres:17
        restart: unless-stopped
        environment:
            POSTGRES_USER: ${DOCKER_POSTGRES_USER}
            POSTGRES_PASSWORD: ${DOCKER_POSTGRES_PASSWORD}
            POSTGRES_DB: ${DOCKER_POSTGRES_DB}
        ports:
            - '${DOCKER_POSTGRES_PORT}:5432'
        volumes:
            - db:/var/lib/postgresql/data

    matomo_db:
        image: mysql:8.0
        restart: unless-stopped
        environment:
            MYSQL_ROOT_PASSWORD: ${MATOMO_DB_ROOT_PASSWORD:-rootpassword}
            MYSQL_DATABASE: ${MATOMO_DB_NAME:-matomo}
            MYSQL_USER: ${MATOMO_DB_USER:-matomo}
            MYSQL_PASSWORD: ${MATOMO_DB_PASSWORD:-matomo}
        volumes:
            - matomo_db:/var/lib/mysql
        command: --default-authentication-plugin=mysql_native_password
    
    matomo:
        image: matomo:latest
        restart: unless-stopped
        ports:
            - '${MATOMO_PORT:-8081}:80'
        environment:
            - MATOMO_DATABASE_HOST=matomo_db
            - MATOMO_DATABASE_ADAPTER=mysql
            - MATOMO_DATABASE_TABLES_PREFIX=matomo_
            - MATOMO_DATABASE_USERNAME=${MATOMO_DB_USER:-matomo}
            - MATOMO_DATABASE_PASSWORD=${MATOMO_DB_PASSWORD:-matomo}
            - MATOMO_DATABASE_DBNAME=${MATOMO_DB_NAME:-matomo}
        volumes:
            - matomo_data:/var/www/html
        depends_on:
            - matomo_db

    adminer:
        image: adminer:latest
        ports:
            - 8080:8080
    server:
        build:
            context: .
            dockerfile: Dockerfile
        working_dir: /app
        volumes:
            - .:/app
            - /app/node_modules
        ports:
            - '${DOCKER_SERVER_PORT}:5000'
        environment:
            - NODE_ENV=development
            - PORT=5000
            - DATABASE_URL=postgresql://${DOCKER_POSTGRES_USER}:${DOCKER_POSTGRES_PASSWORD}@db:5432/${DOCKER_POSTGRES_DB}
            - MATOMO_URL=http://matomo
            - MATOMO_SITE_ID=${MATOMO_SITE_ID:-1}
        depends_on:
            - db
    frontend:
        build:
            context: ../frontend
            dockerfile: Dockerfile
        working_dir: /app
        volumes:
            - ../frontend:/app
            - /app/node_modules
        ports:
            - '${DOCKER_FRONTEND_PORT}:5174'
        environment:
            - NODE_ENV=development
            - VITE_API_URL=http://localhost:${DOCKER_SERVER_PORT}/api
            - VITE_MATOMO_URL=http://localhost:${MATOMO_PORT:-8081}
            - VITE_MATOMO_SITE_ID=${MATOMO_SITE_ID:-1}
        depends_on:
            - server

volumes:
    db:
    matomo_db:
    matomo_data:
